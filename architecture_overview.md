# מסמך ארכיטקטורה: מערכת "הדוור הבא" מבוססת Firebase

## 1. מבוא
מסמך זה מתאר את הארכיטקטורה המוצעת למערכת "הדוור הבא", מערכת לניהול משלוחים אישיים לעובדי חברות. המערכת תפותח על גבי פלטפורמת Firebase של גוגל ותכלול שלוש אפליקציות מרכזיות: אפליקציית לקוח, אפליקציית ניהול ואפליקציית שליחים.

## 2. רכיבי המערכת
המערכת תורכב מהרכיבים הבאים, תוך שימוש בשירותי Firebase השונים:

| רכיב | תיאור | שירותי Firebase | פלטפורמה | 
| :--- | :--- | :--- | :--- |
| **אפליקציית לקוח** | מאפשרת למשתמשים ראשיים ומשניים להוסיף חבילות לאיסוף, לעקוב אחר סטטוס, לנהל משתמשים משניים ולבצע תשלומים. | `Authentication`, `Firestore`, `Storage`, `Cloud Functions` | Web (React) |
| **אפליקציית ניהול** | ממשק למנהלי המערכת לניהול לקוחות, חבילות, שליחים, חברות, וקבלת דוחות ותובנות עסקיות. | `Authentication`, `Firestore`, `Cloud Functions` | Web (React) |
| **אפליקציית שליחים** | כלי עבודה לשליחים המאפשר צפייה במשימות איסוף ומסירה, עדכון סטטוסים, ניווט, ותקשורת. | `Authentication`, `Firestore`, `Storage`, `Cloud Functions` | Web (React) |
| **Backend** | לוגיקה עסקית, אוטומציות, ואינטגרציות עם שירותים חיצוניים (כמו WhatsApp ואימייל). | `Cloud Functions`, `Firestore` | Node.js |

## 3. ארכיטקטורת נתונים (Data Model)
בסיס הנתונים המרכזי יהיה **Firestore**. להלן מבנה האוספים (Collections) הראשיים:

- **`users`**: יכיל את כל המשתמשים במערכת (לקוחות, מנהלים, שליחים).
  - `uid`: מזהה ייחודי (מ-Authentication).
  - `email`: כתובת אימייל.
  - `phoneNumber`: מספר טלפון.
  - `displayName`: שם מלא.
  - `role`: תפקיד (`customer`, `admin`, `courier`).
  - `companyId`: (ללקוחות) שיוך לחברה.
  - `isPrimary`: (ללקוחות) האם משתמש ראשי.
  - `familyId`: (ללקוחות) מזהה משפחה, לקישור בין משתמש ראשי למשניים.

- **`packages`**: יכיל את כל החבילות במערכת.
  - `packageId`: מזהה ייחודי.
  - `customerId`: מזהה הלקוח (בעל החבילה).
  - `trackingNumber`: מספר מעקב.
  - `pickupDetails`: אובייקט עם פרטי האיסוף (שם מקום, כתובת, שעות פעילות).
  - `status`: סטטוס החבילה (`pending_pickup`, `collected`, `in_delivery`, `delivered`, `issue`).
  - `createdAt`: תאריך יצירה.
  - `updatedAt`: תאריך עדכון אחרון.
  - `courierId`: (אופציונלי) מזהה השליח המטפל.

- **`companies`**: יכיל את החברות המקבלות שירות.
  - `companyId`: מזהה ייחודי.
  - `name`: שם החברה.
  - `address`: כתובת.
  - `contactPerson`: איש קשר.
  - `deliveryDays`: ימי חלוקה.

- **`payments`**: יכיל מידע על תשלומים והוראות קבע.
  - `paymentId`: מזהה ייחודי.
  - `familyId`: מזהה המשפחה המשלמת.
  - `amount`: סכום.
  - `status`: סטטוס תשלום.
  - `date`: תאריך.

## 4. זרימת עבודה עיקרית: הוספת חבילה לאיסוף
1.  **בקשת לקוח**: הלקוח שולח פרטי חבילה דרך אחת משלוש הדרכים (WhatsApp, העלאת קובץ/טקסט, טופס ידני).
2.  **קליטת נתונים**: 
    - **WhatsApp**: `Cloud Function` המקושר ל-API של WhatsApp (למשל, Twilio) יקבל את ההודעה, יזהה את המשתמש לפי מספר הטלפון, וישתמש ב-AI (כמו Gemini או מודל שפה אחר) כדי לחלץ את פרטי החבילה מהטקסט.
    - **אפליקציה**: האפליקציה תעלה את הנתונים (טקסט, תמונה או טופס) ל-`Cloud Function`.
3.  **עיבוד ויצירת רשומה**: ה-`Cloud Function` יעבד את הנתונים, ייצור רשומה חדשה באוסף `packages` ב-Firestore עם סטטוס `pending_pickup`.
4.  **שליחת התראה**: `Cloud Function` נוסף (יופעל על ידי יצירת הרשומה ב-Firestore) ישלח הודעת WhatsApp אוטומטית ללקוח המאשרת את קבלת הבקשה.
5.  **הצגה בממשקים**: החבילה החדשה תופיע בזמן אמת בממשק הניהול ובאפליקציית השליחים, מוכנה לשיבוץ לאיסוף.

## 5. טכנולוגיות וכלים
- **פלטפורמה**: Firebase (Authentication, Firestore, Storage, Cloud Functions, Hosting).
- **Frontend**: React (ספריית JavaScript לבניית ממשקי משתמש).
- **Backend (Cloud Functions)**: Node.js.
- **אינטגרציית WhatsApp**: Twilio API for WhatsApp.
- **שליחת אימיילים**: SendGrid API.
- **עיבוד תמונה וטקסט (OCR/NLP)**: Google Cloud Vision AI / Gemini.
- **ניהול תלויות**: pnpm.

## 6. שלבי פיתוח מוצעים
הפיתוח יתבצע בשלבים, בהתאם לתכנית העבודה המעודכנת:
1.  הגדרת פרויקט Firebase וסביבת הפיתוח.
2.  מימוש מודל הנתונים ב-Firestore.
3.  הקמת מערכת האימות (Authentication) לכל סוגי המשתמשים.
4.  פיתוח ה-Cloud Functions המרכזיים (קליטת חבילות, עדכון סטטוסים, שליחת התראות).
5.  פיתוח אפליקציות ה-Web (לקוח, ניהול, שליחים) במקביל, תוך התממשקות ל-Backend.
6.  אינטגרציה, בדיקות מקיפות ופריסה.

---
מסמך זה מהווה בסיס ראשוני. פרטים נוספים יתוכננו ויוגדרו בהמשך כל שלב בפרויקט.
